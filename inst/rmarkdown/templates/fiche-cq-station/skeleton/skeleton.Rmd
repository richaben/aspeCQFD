---
title: "Fiche CQ données ASPE - Station `r params$code_station`"
author: "`r params$auteur`"
subtitle: "`r unique(df_data[df_data$code_sta_pp %in% params$code_station,]$sta_libelle_sandre)`"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document :
    highlight: pygments #default, tango, pygments, kate, monochrome, espresso, zenburn, haddock, and textmate 
    theme: default #“default”, “cerulean”, “journal”, “flatly”, “readable”, “spacelab”, “united”, “cosmo”, “lumen”, “paper”, “sandstone”, “simplex”, “yeti”
    toc: false
    css: 'ofb_theme_html.css'
params:
  df_data: NULL
  code_station: "03174000_005"
  auteur: "DR Normandie"
  annee_debut: 1995
  annee_fin: 2012
  interactive: NULL  
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE)
```

```{r, echo = FALSE}
htmltools::img(src = knitr::image_uri('logo_OFB_v2.png'),
               alt = 'logo',
               style = 'position:absolute; top:0; right:0; padding:10px; width:180px;')
```


> ⚠ **Important / Préambule** :<br><br>
> 
> Les données couvrent la période de **`r params$annee_debut` à `r params$annee_fin`** (paramètres de filtres pour la génération de cette fiche). <br>
> Les graphiques présentés ci-dessous ont pour vocation principale à la mise en qualité des données (et pas vraiment à l'analyse des variations sur les variables bancarisées). Les graphiques, confrontés entre eux, permettent de détecter d'éventuelles erreurs ou problèmes de cohérence dans les données. <br> 
>

## Résumé des opérations

```{r}
ope_list <-
  get_liste_ope_station(df = aspe_table_fiches, 
                      code_sta_pp = params$code_station) %>%
  dplyr::select(-dept) %>% 
  dplyr::filter(format(ope_date, "%Y") >= params$annee_debut & 
                  format(ope_date, "%Y") <= params$annee_fin)

df_station <-
  aspe_table_fiches %>% 
  dplyr::filter(code_sta_pp == params$code_station) %>% 
  dplyr::filter(format(ope_date, "%Y") >= params$annee_debut & 
                  format(ope_date, "%Y") <= params$annee_fin)

df_station_ope_env <-
  aspe_table_fiches_ope_env %>% 
  dplyr::filter(code_sta_pp == params$code_station) %>% 
  dplyr::filter(format(ope_date, "%Y") >= params$annee_debut & 
                  format(ope_date, "%Y") <= params$annee_fin)

df_station_peuplement <-
  aspe_table_fiches_peuplement %>% 
  dplyr::filter(code_sta_pp == params$code_station) %>% 
  dplyr::filter(format(ope_date, "%Y") >= params$annee_debut & 
                  format(ope_date, "%Y") <= params$annee_fin)


df_station_ipr <-
  aspe_table_fiches_ipr %>% 
  dplyr::filter(code_sta_pp == params$code_station) %>% 
  dplyr::filter(format(ope_date, "%Y") >= params$annee_debut & 
                  format(ope_date, "%Y") <= params$annee_fin)

df_station_proba_esp_ipr <-
  aspe_table_proba_esp_ipr %>% 
  dplyr::filter(code_sta_pp == params$code_station) %>% 
  dplyr::filter(format(ope_date, "%Y") >= params$annee_debut & 
                  format(ope_date, "%Y") <= params$annee_fin)

df_station_param_ipr <-
aspe_table_fiches_ipr_env %>% 
  dplyr::filter(code_sta_pp == params$code_station) %>% 
  dplyr::filter(format(ope_date, "%Y") >= params$annee_debut & 
                  format(ope_date, "%Y") <= params$annee_fin)
```

Pour cette station, il y a **`r nrow(ope_list)` opération(s)** bancarisée(s) dans ASPE (entre l'année `r params$annee_debut` et l'année `r params$annee_fin`, paramètres de filtres). 

```{r}
ope_list %>% 
  dplyr::select(-ope_commentaire) %>% 
  knitr::kable()
```

### Jours de pêche sur la station

```{r, fig.width=8, fig.height=4}
ope_list %>% 
 plot_jour_peche()
```

## Objectifs et protocole de pêche

```{r, fig.width=11, fig.height=4}
df_station %>% 
  plot_objectif_reseau()
```

```{r, fig.width=11, fig.height=6}
df_station %>% 
  select_infos_context() %>% 
  plot_infos_context()
```


## Mise en oeuvre de la pêche
### Description pêche

```{r, fig.width=10, fig.height=6}
df_station_ope_env %>% 
  plot_proto_prospec_passage()
```

### Descriptions pêche et environnement

```{r, fig.width=10, fig.height=10}
df_station_ope_env %>% 
  plot_descript_peche_env()
```


## Données environnementales
### faciès

```{r, fig.width=10, fig.height=9}
df_station_ope_env %>% 
  plot_facies_data()
```

### habitat

```{r, fig.width=10, fig.height=8.5}
df_station_ope_env %>% 
   plot_habitat_data()
```


## Saisies piscicoles
### Le cortège d'espèces

```{r, fig.height=7.5, fig.width=12}
df_station_peuplement %>%
  plot_peuplement_data()
```

### L'indice poisson rivière (IPR)

```{r, fig.width=10, fig.height=7}
df_station_ipr %>% 
  plot_ipr_station(df = ., 
                   df_col_ipr = tab_col_class_ipr())
```


```{r, fig.width=10, fig.height=8}
df_station_ipr %>% 
  plot_ipr_metrique()
```


```{r, fig.width=12, fig.height=7}
df_station_proba_esp_ipr %>% 
  plot_ipr_proba_esp_station()
```

```{r, fig.width=10, fig.height=7.5}
df_station_param_ipr %>%
   plot_ipr_param_station()
```

```{r, fig.width=11, fig.height=6.5}
if(params$interactive == TRUE){
  df_station_param_ipr %>%
   plot_ipr_param_station() %>% 
ggiraph::girafe(ggobj = . #, height_svg = 6, width_svg = 10
                )
} else {
  df_station_param_ipr %>%
   plot_ipr_param_station()
}
# df_station_param_ipr %>%
#    plot_ipr_param_station() %>% 
# ggiraph::girafe(ggobj = . #, height_svg = 6, width_svg = 10
#                 )
```

### Commentaires éventuels

```{r}
ope_list %>% 
  dplyr::select(ope_id, ope_date, ope_commentaire) %>% 
  unique() %>% 
  knitr::kable()
```

