---
title: "Comment créer une fiche CQ pour une station ?"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{creation-fiche-cq}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = FALSE,
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
# install.packages("pak")
pak::pak(c("pascalirz/aspe",
           "richaben/aspeCQFD"))

library(aspe) 
library(aspeCQFD)
```


## Prérequis

### 1) Charger les données ASPE

Une copie de la base de données ASPE sous format `Rdata` est nécessaire, devant comprendre l'ensemble des tables et mesures individuelles. Ce fichier `Rdata` est à créer avec les fonctions dédiées du package `aspe`.

```{r, echo = FALSE}
aspe_tables <-
  aspe::misc_nom_dernier_fichier(repertoire = "D:/1_database/ASPE/database_aspe/processed_data",
                                 pattern = "^tables")
aspe_mei <- 
  aspe::misc_nom_dernier_fichier(repertoire = "D:/1_database/ASPE/database_aspe/processed_data",
                                 pattern = "^mei")
load(aspe_tables)
load(aspe_mei)

rm(aspe_tables, aspe_mei)
```

### 2) Constituer les tableaux nécessaires

Plusieurs tableaux de données sont nécessaires pour la création des fiches CQ stations, pouvant être créés individuellement.

Une fonction inclue dans le package {aspeCQFD} permet de créer en une fois l'ensemble des tables nécessaires.

```{r}
data_fichesCQ <-
  mef_creer_tables_fichesCQ()
```

La liste des tables individuelles est la suivante :

1. table de base, avec les informations sur les dates, objectifs de pêches, intervenants, codes sandre, protocole, etc... (`aspeCQFD::mef_creer_table_base_fiches()`) ;
1. table avec les données des opérations (`aspeCQFD::mef_creer_table_ope_env()` + `aspeCQFD::mef_ajouter_facies()` ) ;
1. table avec les données sur les peuplements piscicoles (`aspeCQFD::mef_creer_table_ope_env()` + `aspeCQFD::mef_ajouter_facies()` ) ;
1. table avec les données ipr des stations ;
1. table avec les données des paramètres pour calculs de l'ipr ;
1. table avec les données sur les probabilités des espèces issues des notes ipr.

```{r}
### 1/ table de base
aspe_table_fiches <-
  mef_creer_table_base_fiches()

### 2/ table avec les données des opérations
aspe_table_fiches_ope_env <-
  aspe_table_fiches %>% 
  mef_creer_table_ope_env() %>% 
  mef_ajouter_facies()

### 3/ table avec les données poissons
aspe_table_fiches_peuplement <-
  aspe_table_fiches %>% 
  mef_creer_table_peuplement()

### 4/ table avec les données ipr
aspe_table_fiches_ipr <-
  aspe_table_fiches_peuplement %>% 
  dplyr::select(code_sta_pp, 
                sta_libelle_sandre, 
                ope_id, 
                annee, 
                ope_date,
                ipr,
                cli_id,
                cli_libelle) %>% 
  dplyr::distinct() %>% 
  aspe::mef_ajouter_metriques() 

### 5/ table avec les données env. associées à l'ipr
aspe_table_fiches_ipr_env <-
  aspe_table_fiches %>% 
  dplyr::select(code_sta_pp, 
                sta_libelle_sandre, 
                ope_id, 
                annee, 
                ope_date,
                pop_id) %>% 
  dplyr::distinct() %>% 
  aspe::mef_ajouter_ope_env()

### 6/ table avec les données proba espèces associées à l'ipr
aspe_table_proba_esp_ipr <-
  aspe_table_fiches %>%
  mef_tab_proba_esp_ipr()

```




## Choisir une station

```{r}
generate_fiche_cq_station(stations = c("03231000_013"#, 
                                       #"03174000_005", 
                                       #"03112710_005"
                                       ),
                          dossier_sortie = "D:/fiches_CQ/",
                          df_data = aspe_table_fiches,
                          auteur = "Jean Dupont",
                          annee_debut = 2007,
                          annee_fin = 2022,
                          interactive = T)

```

